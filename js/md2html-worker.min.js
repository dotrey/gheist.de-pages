onmessage=function(e){postMessage(md2html.html(e.data))};var md2html=function(my){return my.settings={multilineBlocks:["paragraph","blockquote","orderedlist","unorderedlist"],indentableBlocks:["orderedlist","unorderedlist"],multiparagraphBlocks:["codeblock"],unformattedBlocks:["codeblock"]},my.html=function(md){var blocks=this.parse(md);return this.convert(blocks)},my.parse=function(md){for(var lines=md.split("\n"),blocks=[],i=0,ic=lines.length;i<ic;i++)if(lines[i].trim()){var blocktype=this.detectBlockType(lines[i]),indent=this.getIndent(lines[i]);blocks.push(this.createBlock(lines[i],blocktype,indent))}else blocks.push(null);var mergedBlocks;return this.mergeBlocks(blocks)},my.mergeBlocks=function(blocks){for(var merged=[],lastBlock=null,i=0,ic=blocks.length;i<ic;i++)if(!lastBlock||blocks[i])if(lastBlock){if(this.isUnformatted(lastBlock)){lastBlock.appendLine(blocks[i].line),lastBlock.type===blocks[i].type&&(lastBlock=null);continue}var newBlockParent,newBlockParent;if(lastBlock.type!==blocks[i].type)if(this.isIndentable(lastBlock)&&this.isIndentable(blocks[i]))(newBlockParent=this.findParentBlock(lastBlock,blocks[i]))&&newBlockParent.type===blocks[i].type&&newBlockParent.indent===blocks[i].indent?(lastBlock=newBlockParent).appendLine(blocks[i].line):((lastBlock=blocks[i]).appendTo(newBlockParent),newBlockParent||merged.push(lastBlock));else lastBlock=blocks[i],merged.push(lastBlock);else if(this.isIndentable(lastBlock))if(lastBlock.indent===blocks[i].indent)lastBlock.appendLine(blocks[i].line);else(newBlockParent=this.findParentBlock(lastBlock,blocks[i]))&&newBlockParent.type===blocks[i].type&&newBlockParent.indent===blocks[i].indent?(lastBlock=newBlockParent).appendLine(blocks[i].line):((lastBlock=blocks[i]).appendTo(newBlockParent),newBlockParent||merged.push(lastBlock));else lastBlock.appendLine(blocks[i].line)}else(lastBlock=blocks[i])&&merged.push(lastBlock);else this.isMultiParagraph(lastBlock)?lastBlock.appendLine(""):lastBlock=null;return merged},my.findParentBlock=function(oldBlock,newBlock){return oldBlock.indent<newBlock.indent?oldBlock:oldBlock.indent===newBlock.indent?oldBlock.type===newBlock.type?oldBlock:oldBlock.parent:this.findParentBlock(oldBlock.parent,newBlock)},my.createBlock=function(line,type,indent){return{line:line,type:type,indent:indent,lines:[line],parent:null,appendLine:function(line){this.lines.push(line)},appendTo:function(parent){this.parent=parent,parent&&parent.appendLine(this)}}},my.convert=function(blocks){for(var result="",i=0,ic=blocks.length;i<ic;i++)result+=this.converter.convert(blocks[i])+"\n\n";return result},my.converter={convert:function(block){if("function"==typeof this[block.type])return this[block.type](block);this.unknown(block)},heading:function(block){for(var count=0,line=block.lines[0];line.length&&0===line.indexOf("#");)count++,line=line.substr(1);return"<h"+(count=Math.min(Math.max(1,count),6))+">"+(line=my.inline.angleBrackets(line.trim()))+"</h"+count+">"},paragraph:function(block){for(var r="<p>",i=0,ic=block.lines.length;i<ic;i++)void 0!==block.lines[i].type?r+=this.convert(block.lines[i]):r+=my.inline.replace(block.lines[i])+"\n";return r+="</p>"},blockquote:function(block){for(var r="<blockquote>",i=0,ic=block.lines.length;i<ic;i++)if(void 0!==block.lines[i].type)r+=this.convert(block.lines[i]);else{var line=block.lines[i].trim().substr(1).trim();r+=my.inline.replace(line)+"\n"}return r+="</blockquote>"},codeblock:function(block){for(var r="",i=0,ic=block.lines.length;i<ic;i++)if(0!==block.lines[i].indexOf("```")){var line=my.inline.angleBrackets(block.lines[i]);r+="<li>"+(line=my.inline.nbsp(line))+"</li>\n"}return r='<ol class="codeblock">'+r+"</ol>"},orderedlist:function(block){for(var r="<ol>",i=0,ic=block.lines.length;i<ic;i++)if(void 0!==block.lines[i].type)r.indexOf("</li>")?r=r.substr(0,r.lastIndexOf("</li>")):r+="<li>",r+=this.convert(block.lines[i])+"</li>";else{var line=block.lines[i].trim().substr(2).trim();r+="<li>"+my.inline.replace(line)+"</li>"}return r+="</ol>"},unorderedlist:function(block){for(var r="<ul>",i=0,ic=block.lines.length;i<ic;i++)if(void 0!==block.lines[i].type)r.indexOf("</li>")?r=r.substr(0,r.lastIndexOf("</li>")):r+="<li>",r+=this.convert(block.lines[i])+"</li>";else{var line=block.lines[i].trim().substr(1).trim();r+="<li>"+my.inline.replace(line)+"</li>"}return r+="</ul>"},horizontalline:function(block){return"<hr/>"},horizontalbreak:function(block){return'<hr class="horizontal-break" />'},rawhtml:function(block){for(var r="",i=0,ic=block.lines.length;i<ic;i++)r+=block.lines[i].trim().substr(4).trim()+"\n";return r},unknown:function(block){return"<i>unknown block type: "+block.type+"</i>"+this.paragraph(block)}},my.inline={replace:function(string){return string=this.angleBrackets(string),string=this.inlineCode(string),string=this.image(string),string=this.link(string),string=this.url(string),string=this.task(string),string=this.iframe(string),string=this.forcedLineBreak(string),string=this.emphasis(string)},task:function(string){return string=string.replace(/(^|\s)\[([ x~])\]\s/gm,'<span class="task" data-value="$2"></span>')},image:function(string){return string=string.replace(/!\[([^\]]*?)\]\(([^)]*?)\)(\{([^}]*?)\})?/g,'<img src="$2" title="$1" class="$3" />')},link:function(string){return string=string.replace(/\[([^\]]*?)\]\(([^)]*?)\)/g,'<a href="$2">$1</a>')},url:function(string){return string=string.replace(/(\s)(https?:\/\/[^\s]+)/g,'$1<a href="$2">$2</a>')},iframe:function(string){return string=string.replace(/\[\[\[(.*?)\]\]\]/g,'<iframe src="$1"></iframe>')},forcedLineBreak:function(string){return string=string.replace(/(^|\s)!!br(\s|$)/gm,"<br/>")},inlineCode:function(string){function codeSpan(value){return'<span class="inline-code">'+(value=value.substr(1,value.length-2)).replace("<","&lt;").replace(">","&gt;").replace("[","&#91;")+"</span>"}return string=string.replace(/`[^`\n]+?`/g,codeSpan)},emphasis:function(string){return string=this.bold(string),string=this.italic(string),string=this.strike(string)},bold:function(string){return string=(string=string.replace(/\*\*([\S].*?[\S])\*\*/g,"<b>$1</b>")).replace(/__([\S].*?[\S])__/g,"<b>$1</b>")},strike:function(string){return string=string.replace(/~~([\S].*?[\S])~~/g,"<s>$1</s>")},italic:function(string){return string=(string=string.replace(/\*([^\s*].*?[^\s*])\*/g,"<i>$1</i>")).replace(/_([^\s_].*?[^\s_])_/g,"<i>$1</i>")},nl2br:function(string){return string=string.replace(/\n/g,"<br/>")},nbsp:function(string){return string=string.replace(/ /g,"&nbsp;")},angleBrackets:function(string){return string=(string=string.replace(/</g,"&lt;")).replace(/>/g,"&gt;")}},my.detectBlockType=function(line){var start;if((line=(line||"").trim()).indexOf(" ")>0)switch(line.split(" ",2)[0]){case"#":case"##":case"###":case"####":case"#####":case"######":return"heading";case"*":case"-":return"unorderedlist";case"1.":return"orderedlist";case">":return"blockquote";case"```":return"codeblock";case"----":return"horizontalline";case"====":return"horizontalbreak";case"!!>>":return"rawhtml"}return 0===line.indexOf("```")?"codeblock":0===line.indexOf("----")?"horizontalline":0===line.indexOf("====")?"horizontalbreak":"paragraph"},my.getIndent=function(line){for(var i=0;0===line.indexOf(" ");)i++,line=line.substr(1);return i},my.isIndentable=function(block){return this.settings.indentableBlocks.indexOf(block.type)>=0},my.isMultiline=function(block){return this.settings.multilineBlocks.indexOf(block.type)>=0},my.isMultiParagraph=function(block){return this.settings.multiparagraphBlocks.indexOf(block.type)>=0},my.isUnformatted=function(block){return this.settings.unformattedBlocks.indexOf(block.type)>=0},my}(md2html||{});md2html.inline.link=function(string){return string=(string=string.replace(/\[([^\]]*?)\]\(\/([^)]*?)\)(\{([^}]*?)\})?/g,'<a href="#!/$2" class="$4">$1</a>')).replace(/\[([^\]]*?)\]\(([^)]*?)\)(\{([^}]*?)\})?/g,'<a href="$2" class="$4">$1</a>')},md2html.inline.image=function(string){return string=string.replace(/!\[([^\]]*?)\]\(([^)]*?)\)(\{([^}]*?)\})?/g,'<span class="img $4" data-src="$2" title="$1" onclick="site.enlargeImage(this);"></span>')},md2html.inline.iframe=function(string){return string=(string=string.replace(/\[\[\[(.*?)\]\]\]\{autosize\}/g,'<iframe src="$1" onload="site.iframeSizeToContent(this)"></iframe>')).replace(/\[\[\[(.*?)\]\]\]/g,'<iframe src="$1"></iframe>')},md2html.converter.heading=function(block){for(var count=0,line=block.lines[0];line.length&&0===line.indexOf("#");)count++,line=line.substr(1);count=Math.min(Math.max(1,count),6);var attr="";return(line=md2html.inline.angleBrackets(line.trim())).match(/^\([^)]+?\).+/)&&(attr=' data-date="'+line.substr(1,line.indexOf(")")-1)+'"',line=line.substr(line.indexOf(")")+1).trim()),"<h"+count+attr+">"+line+"</h"+count+">"};